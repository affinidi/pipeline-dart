name: check
on:
  workflow_call:
    inputs:
      flutter-version:
        type: string
        required: false
        default: '3.32.4'
      repo-path:
        required: false
        default: '.'
        type: string
      package:
        description: "If repository is a publishable package, run package analyzer"
        required: false
        default: false
        type: boolean
      pana_min_score:
        description: "Minimum score required by pana analyzer"
        required: false
        default: 160
        type: number
      pana_allow_failure:
        description: "Allow pana analyzer to fail without failing the workflow"
        required: false
        default: true
        type: boolean
      env_vars:
        description: "Environment variables that will be passed to the build"
        required: false
        type: string

jobs:
  # dart-scan:
  #   uses: affinidi/pipeline-security/.github/workflows/dart-scanner.yml@main
  #   with:
  #     repo-path: ${{ inputs.repo-path }}
  #     flutter-version: ${{ inputs.flutter-version }}
  #   secrets: inherit
  build:
    # needs: [dart-scan]
    runs-on: ubuntu-latest
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        options: --env KMS=true

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
        
      - name: Fetch base ref
        if: github.event_name == 'pull_request'
        run: git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
      - name: Set environment variables
        run: |
          echo "${{ inputs.env_vars }}" | while IFS= read -r line
          do
            if [ -n "$line" ]
            then
              # Split the line into key and value based on "=" character.
              key="${line%%=*}"        # Retain the part before the first "="
              val="${line#*=}"         # Retain the part after the first "="
              echo "::add-mask::$val"  # Mask values because they could be sensitive
              echo "INFO: Setting variable $key"
              echo "${key}=${val}" >> "$GITHUB_ENV"
            fi
          done      

      # Note: This workflow uses the latest stable version of the Fluter+Dart SDK.
      # You can specify other versions if desired, see documentation here:
      # https://github.com/flutter-actions/setup-flutter/blob/main/README.md
      - uses: flutter-actions/setup-flutter@v3
        with:
          channel: stable
          version: ${{ inputs.flutter-version }}
      - uses: bluefireteam/melos-action@v3
      # - name: Check formatting
      #   run: melos format --output=none --set-exit-if-changed .
      # - name: Run static analysis
      #   run: melos analyze
      # - name: Run tests
      #   run: melos test
      # - uses: romeovs/lcov-reporter-action@v0.3.1
      #   with:
      #     lcov-file: ./coverage/lcov.info
      - name: Install pana
        if: ${{ inputs.package == true }}
        run: dart pub global activate pana
      - name: Install jq
        if: ${{ inputs.package == true }}
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Run package analyzer
        if: ${{ inputs.package == true }}
        run: |
          export PATH="$PATH:$HOME/.pub-cache/bin"
          RESULTS_DIR="$(pwd)/pana_results"
          mkdir -p "$RESULTS_DIR"
          
          OVERALL_EXIT_CODE=0
          
          melos exec --no-private -- '\
              echo "ðŸ“¦ Analyzing package: $MELOS_PACKAGE_NAME"
              
              # Create a temp file for pana output
              TEMP_FILE=$(mktemp)
              
              # Run pana and save output to temp file
              if pana --source path . --json > "$TEMP_FILE" 2>&1; then
                # Check if the output is valid JSON
                if jq . "$TEMP_FILE" > /dev/null 2>&1; then
                  # Copy valid JSON to results directory
                  cp "$TEMP_FILE" "'$RESULTS_DIR'/$MELOS_PACKAGE_NAME.json"
                  PACKAGE_SCORE=$(jq -r ".scores.grantedPoints // 0" "$TEMP_FILE" 2>/dev/null || echo "0")
                else
                  # Invalid JSON - create error file
                  echo "{\"error\": \"Invalid JSON output\", \"raw_output\": \"$(head -c 500 "$TEMP_FILE" | sed "s/\"/\\\\\"/g")\"}" > "'$RESULTS_DIR'/$MELOS_PACKAGE_NAME.json"
                  PACKAGE_SCORE=0
                fi
              else
                # Pana failed - create error file
                echo "{\"error\": \"Pana execution failed\", \"raw_output\": \"$(head -c 500 "$TEMP_FILE" | sed "s/\"/\\\\\"/g")\"}" > "'$RESULTS_DIR'/$MELOS_PACKAGE_NAME.json"
                PACKAGE_SCORE=0
              fi
              
              # Clean up temp file
              rm -f "$TEMP_FILE"
              
              # Ensure PACKAGE_SCORE is numeric
              case "$PACKAGE_SCORE" in
                ''|*[!0-9]*) PACKAGE_SCORE=0 ;;
              esac
              
              if [ "$PACKAGE_SCORE" -lt ${{ inputs.pana_min_score }} ]; then
                echo "âŒ $MELOS_PACKAGE_NAME: Score ($PACKAGE_SCORE) below minimum requirement of ${{ inputs.pana_min_score }}"
                if [ "${{ inputs.pana_allow_failure }}" = "false" ]; then
                  exit 1
                fi
              else
                echo "âœ… $MELOS_PACKAGE_NAME: Score ($PACKAGE_SCORE) meets the minimum requirement of ${{ inputs.pana_min_score }}"
              fi
            ' || OVERALL_EXIT_CODE=$?
          
          if [ "${{ inputs.pana_allow_failure }}" = "false" ] && [ $OVERALL_EXIT_CODE -ne 0 ]; then
            exit $OVERALL_EXIT_CODE
          fi
      
      - name: Generate Pana Summary
        if: ${{ inputs.package == true && github.event_name == 'pull_request' }}
        run: |
          echo "# ðŸ“Š Pana Analysis Results" > pana_summary.md
          echo "" >> pana_summary.md
          echo "| Package | Score | Status | Issues |" >> pana_summary.md
          echo "|---------|-------|---------|---------|" >> pana_summary.md
          
          for result_file in pana_results/*.json; do
            if [ -f "$result_file" ]; then
              package_name=$(basename "$result_file" .json)
              score=$(jq -r '.scores.grantedPoints // "N/A"' "$result_file")
              max_score=$(jq -r '.scores.maxPoints // "N/A"' "$result_file")
              
              if [ "$score" = "N/A" ]; then
                status="âŒ Failed"
                issues="Analysis failed"
              elif [ "$score" -lt ${{ inputs.pana_min_score }} ]; then
                status="âš ï¸ Below threshold"
                issues=$(jq -r '[.suggestions[]?.title // empty] | join(", ")' "$result_file" | head -c 100)
                if [ ${#issues} -gt 95 ]; then
                  issues="${issues}..."
                fi
              else
                status="âœ… Pass"
                issues="-"
              fi
              
              echo "| \`$package_name\` | $score/$max_score | $status | $issues |" >> pana_summary.md
            fi
          done
          
          echo "" >> pana_summary.md
          echo "**Minimum required score:** ${{ inputs.pana_min_score }}" >> pana_summary.md
          echo "**Allow failures:** ${{ inputs.pana_allow_failure }}" >> pana_summary.md
      
      - name: Comment PR with Pana Results
        if: ${{ inputs.package == true && github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const summary = fs.readFileSync('pana_summary.md', 'utf8');
              const prNumber = context.payload.pull_request?.number || context.issue.number;
              
              if (!prNumber) {
                console.log('No PR number found, skipping comment');
                return;
              }
              
              // Always create a new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: summary
              });
              
              console.log('Pana analysis results posted to PR');
            } catch (error) {
              console.log('Error posting pana summary:', error);
            }